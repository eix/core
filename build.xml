<?xml version="1.0" encoding="UTF-8"?>
<project default="package">

	<property name="srcDir" value="src/php" />
	<property name="mainSrcDir" value="${srcDir}/main" />
	<property name="testsDir" value="${srcDir}/test" />
	<property name="libsDir" value="${srcDir}/lib" />
	<property name="buildDir" value="build" />
	<property name="mainTargetDir" value="${buildDir}/target/main" />
	<property name="develTargetDir" value="${buildDir}/target/devel" />
	<property name="distFileName" value="${phing.project.name}-${version}" />
	<!-- Import custom properties -->
	<property file="build.properties" />

	<fileset dir="${srcDir}" id="main">
		<include name="bootstrap.php" />
		<include name="phar_stub.php" />
		<include name="**/*.php" />
	</fileset>

	<fileset dir="${srcDir}" id="tests">
		<include name="test_bootstrap.php" />
		<include name="tests/**/*.php" />
	</fileset>

	<fileset dir="${libsDir}" id="libs">
		<include name="**/*.php" />
		<!-- Phars are never packaged inside phars. -->
		<exclude name="**/*.phar" />
	</fileset>

	<target name="prepare">
		<!-- Ensure the build folder is clean -->
		<delete dir="${buildDir}" />
		<!-- Ensure the build folder exists -->
		<mkdir dir="${buildDir}" />
	</target>

	<target name="check"
		depends="prepare"
		description="Ensure code quality"
	>
		<phpcodesniffer
			standard="PSR2"
			format="full"
			file="${srcDir}"
			docFile="${reportsDir}/codesniffer.log"
			allowedFileExtensions="php js css html"
		/>
	</target>

	<target name="test"
		depends="prepare"
		description="Ensure the functionality meets expectations"
	>
		<phpunit
			configuration="phpunit.xml"
			printsummary="true"
		>
			<batchtest>
				<fileset dir="${testsDir}">
					<include name="**/*Test.php"/>
				</fileset>
			</batchtest>
		</phpunit>
	</target>

<!--
-->
	<target name="build"
		description="Gather the files that make up a package"
		depends="test"
	>
		<!-- Prepare main target folder. -->
		<delete dir="${mainTargetDir}" />
		<mkdir dir="${mainTargetDir}" />
		<copy todir="${mainTargetDir}">
			<fileset refid="main" />
		</copy>

		<!-- Prepare development target folder. -->
		<delete dir="${develTargetDir}" />
		<mkdir dir="${develTargetDir}" />
		<copy todir="${develTargetDir}">
			<fileset refid="main" />
			<fileset refid="tests" />
		</copy>
	</target>

	<target name="package"
		depends="build"
		description="Build a distributable package"
	>
		<tstamp>
			<format property="creationDate" pattern="%Y-%m-%d %H:%I:%S" />
			<format property="currentYear" pattern="%Y" />
			<format property="buildDate" pattern="%s" />
		</tstamp>

		<!-- Build a phar with the main code -->
		<pharpackage
			destfile="${buildDir}/${distFileName}.phar"
			basedir="${mainTargetDir}"
			stub="${mainTargetDir}/phar_stub.php"
			signature="sha512"
		>
			<fileset dir="${mainTargetDir}">
				<include name="**/*" />
			</fileset>

			<metadata>
				<element name="title" value="${phing.project.name}" />
				<element name="description" value="${phing.project.description}" />
				<element name="version" value="${version}" />
				<element name="build" value="${buildDate}" />
				<element name="created" value="${creationDate}" />
				<element name="copyright" value="Nohex (c) 2012-${currentYear}" />
				<element name="authors">
					<element name="Max Noé">
						<element name="e-mail" value="max@nohex.com" />
					</element>
				</element>
			</metadata>
		</pharpackage>

		<!-- Build a phar with the main code and the development code -->
		<pharpackage
			destfile="${buildDir}/${distFileName}-devel.phar"
			basedir="${develTargetDir}"
			stub="${develTargetDir}/phar_stub.php"
			signature="sha512"
		>
			<fileset dir="${develTargetDir}">
				<include name="**/*" />
			</fileset>

			<metadata>
				<element name="title" value="${phing.project.name}" />
				<element name="description" value="${phing.project.description}" />
				<element name="version" value="${version}" />
				<element name="build" value="${buildDate}" />
				<element name="created" value="${creationDate}" />
				<element name="copyright" value="Nohex (c) 2012-${currentYear}" />
				<element name="authors">
					<element name="Max Noé">
						<element name="e-mail" value="max@nohex.com" />
					</element>
				</element>
			</metadata>
		</pharpackage>
	</target>
</project>
