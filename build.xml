<?xml version="1.0" encoding="UTF-8"?>
<project name="eix" default="build" description="Eix">

	<property name="testDir" value="test" />
	<property name="testClassesDir" value="${testDir}/php" />
	<property name="srcDir" value="src/php/main" />
	<property name="buildDir" value="build" />
	<property name="reportsDir" value="${buildDir}/reports" />
	<property name="classesDir" value="${buildDir}/classes" />
	<property name="deployLocation" value="/usr/share/php" />

	<property name="version" value="0.1.2" />
	<property name="distFile" value="${buildDir}/${phing.project.name}-${version}.phar" />

	<fileset dir="${srcDir}" id="source">
		<include name="**/*.php" />
	</fileset>

	<target name="prepare">
		<mkdir dir="${buildDir}" />
		<delete dir="${buildDir}/*" />
	</target>

	<target name="check" depends="prepare">
		<phpcodesniffer
			standard="PSR2"
			format="full"
			file="${srcDir}"
			docFile="${reportsDir}/codesniffer.log"
			allowedFileExtensions="php js css html"
		/>
	</target>

	<target name="test" depends="check">
		<phpunit
			configuration="${testDir}/phpunit.xml"
			printsummary="true"
		>
			<batchtest>
				<fileset dir="${testClassesDir}">
					<include name="**/*Test.php"/>
				</fileset>
			</batchtest>
		</phpunit>
	</target>

	<target
		name="build"
		depends="test"
		description="Pack up the library so that it can be distributed."
	>
		<mkdir dir="${classesDir}" />
		<copy todir="${classesDir}">
			<fileset refid="source" />
<!-- One of these filters breaks the build.
			<filterchain>
				<stripphpcomments />
				<stripwhitespace />
				<tabtospaces tablength="1" />
			</filterchain>
-->
		</copy>
	</target>

	<target name="package" depends="build">
		<tstamp>
			<format property="creationDate" pattern="%Y-%m-%d %H:%I:%S" />
			<format property="currentYear" pattern="%Y" />
			<format property="buildDate" pattern="%s" />
		</tstamp>

		<pharpackage
			destfile="${distFile}"
			basedir="${classesDir}"
			stub="${classesDir}/phar_stub.php"
			signature="sha512"
		>
			<fileset dir="${classesDir}">
				<include name="**/*" />
			</fileset>

			<metadata>
				<element name="title" value="Eix" />
				<element name="description" value="Eix is a PHP-based framework for building web applications." />
				<element name="version" value="${version}" />
				<element name="build" value="${buildDate}" />
				<element name="created" value="${creationDate}" />
				<element name="copyright" value="Nohex (c) 2012-${currentYear}" />
				<element name="authors">
					<element name="Max NoÃ©">
						<element name="e-mail" value="max@nohex.com" />
					</element>
				</element>
			</metadata>
		</pharpackage>
	</target>

	<target
		name="deploy"
		depends="package"
		description="Leave the distribution file in a place where it can be used."
	>
		<copy file="${distFile}" todir="${deployLocation}" />
	</target>
</project>
